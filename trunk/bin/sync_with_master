#!/usr/bin/env perl

# Use mandatory external modules
use strict;
use Cwd;
use File::Basename;
use Data::Dumper;
use POSIX;
use Config;
use Time::HiRes;
use DBI;

# Determine installation dir name
our $SELF_DIR = dirname(dirname(Cwd::abs_path(__FILE__)));

# Include parts of the system
require $SELF_DIR . '/lib/config.pm';

if (scalar(@ARGV) < 1)
{
    print "ERROR: Usage: $0 <config>";
    exit(1);
}

our $MMM_CONFIG = $ARGV[0];

# Read config file and status
our $config = ReadConfig($MMM_CONFIG);

print SyncWithMaster();

exit(0);

#-----------------------------------------------------------------
sub SyncWithMaster($) {
    my $host = shift;

    my $this = $config->{this};
    
    # get self connection info
    my $host = $config->{host}->{$this}->{ip};
    my $port = $config->{host}->{$this}->{port};
    my $user = $config->{host}->{$this}->{user};
    my $pass = $config->{host}->{$this}->{password};
    my $peer = $config->{host}->{$this}->{peer};

    # get peer connection info
    my $peer_host = $config->{host}->{$peer}->{ip};
    my $peer_port = $config->{host}->{$peer}->{port};
    my $peer_user = $config->{host}->{$peer}->{user};
    my $peer_pass = $config->{host}->{$peer}->{password};
    

    # Repeat the cycle until we don't need to wait for synchronization
    my $loop_no=0;
    while (1)
    {    
      my $this_dbh = MysqlConnect($host, $port, $user, $pass);
      return "ERROR: Can't connect to MySQL (host = $host:$port, user = $user)!"  if (!$this_dbh);
    
      my $peer_dbh = MysqlConnect($peer_host, $peer_port, $peer_user, $peer_pass);
      return "ERROR: Master could not be contacted." unless ($peer_dbh);

      my $row = MysqlQuery($peer_dbh, "SHOW MASTER STATUS");
      my $wait_log = $row->{File};
      my $wait_pos = $row->{Position};
      MysqlDisconnect($peer_dbh);

      my $time_before_sync = time();    
      my $res = ExecuteQuery($this_dbh, "SELECT MASTER_POS_WAIT('$wait_log', $wait_pos)");
      return "ERROR: SQL Query Error: " . $this_dbh->errstr unless($res);
      MysqlDisconnect($this_dbh);

      last if time() - $time_before_sync <= 1 || $loop_no == 10;
    } 

    return "ERROR: Unable to synchronize this host to master." if $loop_no == 10;

    return "OK";
}

#-----------------------------------------------------------------
sub MysqlConnect($$$$) {
    my ($host, $port, $user, $pass) = @_;
    
    my $dsn = "DBI:mysql:host=$host;port=$port";
    return DBI->connect($dsn, $user, $pass, { PrintError => 0 });
}

#-----------------------------------------------------------------
sub MysqlDisconnect($) {
    my ($dbh) = @_;

    $dbh->disconnect();
}

#-----------------------------------------------------------------
sub MysqlQuery($$) {
    my ($dbh, $query) = @_;

    my $sth = $dbh->prepare($query);
    my $res = $sth->execute;
    return $res unless($res);

    my $row = $sth->fetchrow_hashref;
    $sth->finish;

    return $row;
}

#-----------------------------------------------------------------
sub ExecuteQuery($$) {
    my ($dbh, $query) = @_;

    my $sth = $dbh->prepare($query);
    return $sth->execute;
}
