#!/usr/bin/perl

use strict;
use threads;
use threads::shared;
use Thread::Queue;
use Data::Dumper;
use POSIX;
use DBI;

require '/opt/mmm/lib/config.pm';
require '/opt/mmm/lib/log.pm';
require '/opt/mmm/lib/roles.pm';

# Read config file
our $config : shared = ReadConfig("/opt/mmm/mmm_agent.conf");

if (scalar(@ARGV) < 1) {
    print "Usage: $0 <role>\n\n";
    exit(1);
}

my $role = $ARGV[0];
$role =~ /^(.*)\((.*);(.*)\)$/;
my $role_name = $1;
my $ip = $2;
my $master_host = $3;

my $res = CheckRole($role_name, $ip, $master_host);

print "$res\n";
exit(0);

#-----------------------------------------------------------------
sub CheckRole($$$) {
    my $role = shift;
    my $ip = shift;
    my $master_host = shift;
    
    if ($role eq 'reader') {
        CheckIP($ip);
        return "OK: Role 'reader' is here!";
    }
    
    if ($role eq 'writer') {
        AllowWrite();
        CheckIP($ip);
        return "OK: Role 'writer' is here!"
    }
    
    return "ERROR: Unknown role: $role!";
}
