Как работает система
~~~~~~~~~~~~~~~~~~~~

Главное изменение - у каждого сервера "режим" будет навечно прибит в конфиге и будет служить 
только для отбора серверов при выполнении операций над специфичным множеством машин: слейвов 
или мастеров  (на понедельник я сделаю мастеров, слейвы постараюсь сделать, но это будет видно).

Для ролей, которые exclusive, сервера в конфиге должны будут указаны в порядке желаемой 
последовательности фоллбеков. То есть фоллбек - это поиск первого подходящего сервера в 
списке подходящих на роль и переключение роли на него.


В процессе работы мониторинг раз в 5 секунд рассылает серверам команду SET_STATUS с их статусом, 
и списком ролей с параметрами. Сервера, получая свой статус, проверяют все параметры 
системы на предмет соответствия своему статусу и т.п.

??? (надо обдумать) Если сервер не видит свой дефолт-гейтвей, то он имеет право предположить, 
что помер и может не иметь доступа к мониотрингу. Тогда сервер делает себе статус 
AWAITING_RECOVERY и очищает список своих ролей. При следующей связи с мониторинг-сервером, тот 
пришлет этому серверу его свежий статус и тогда можно будет все вернуть назад. 
Тут возникает проблема, связанная с тем, что если вдруг мониторинг останется жив, а дефолт 
пропадет, то статусы на серверах начнут хлопать между тем, что говорит мониторинг и тем, что 
считает сам сервер.
FIXME: если возможно, нужно что-то здесь придумать. 


На серверах кластера будет стоять простой демон, который будет ожидать команд и выполнять 
простые действия по команде:

1) SET_STATUS - установить внутренний статус набор ролей для данного сервера.
  Установка статуса и т.п. состоит в наборе проверок, проверяющих совпадение прошлых 
  параметров с теми, что нам только что прислали.
  Если меняется какой-то их параметров, мы запускаем скрипт-триггер, который 
  устанавливает данный режим:

  - если поменялся набор ролей, то сначала удаляем те, которые у нас забрали (DEL_ROLE role_name), 
    потом ставим те, которые нам добавили (ADD_ROLE role_name). Меняем внутренние 
    структуры данных с учетом присланной информации.

  - если поменялся статус, то запускаем "CHANGE_STATUS status_name" и меняем внутренние 
    структуры данных с учетом присланной информации.

2) PING - просто проверка работы демона. Не повис ли.




Типичные ситуции и логика работы мониторинга
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1) Запуск программы монитотринга.

При запуске демон будет считать, что он ничего не знает о текущей ситуации 
и будет ставить всем серверам статус AWAITING_RECOVERY и никому никаких ролей.

Внимание: Если демон лежал, а сервера работали, то при запуске демона он положит сервера.
FIXME: надо придумать, как быть. Может быть можно как-то можно не ложить их, 
но я пока не знаю, как.

В процессе работы у мониторингового сервера всегда есть список всех возможных в системе 
ролей и за каждой из них закреплен какой-то сервер. Если для данной роли нет кандидатов, 
то роль считается orphaned (детальнее - ниже).


2) Все сервера работают и работает мониторинг и вдруг фэйлится одна или несколько из проверок 
   на один из серверов. Если эти проверки были ping или mysql, то фоллбек:
   - переводит сломанный сервер у себя в hard-offline и пытается форсированно послать 
     команду SET_STATUS сломавшемуся серверу

   - запускает локально скрипт "SERVER_IS_DOWN server_name", которая может пристрелить 
     сервер, если это потребуется.

   - берет все роли с упавшего сервера и находит, куда их прикрутить (сверяясь с 
     результатами проверок серверов и с их статусами)

   - форсированно посылает всем серверам, которые получили новые роли, команды 
     SET_STATUS с измененными параметрами.

  Внимание: В случае падения сразу нескольких серверов, фолбек будет происходить по-очереди.

3) Какой либо из серверов был в AWAITING_RECOVERY и был помечен админом как ONLINE:
   - Происходит отправка серверу команды PING.
   - Если команда не прошла по какой-то причине (не получилось сконнектиться или сервер 
     ответил не OK), то отказываемся от смены статуса.
   - Если пинг прошел, то делаем локально статус сервера ONLINE и шлем серверу SET_STATUS.
   - Далее, проверяем список orphaned roles и передаем серверу эти роли, если он способен 
     их принять. Отправляем еще одну SET_STATUS.

4) Какой либо из серверов был в статусе HARD_OFFLINE, но все проверки говорят, что он жив:
   - Меняем внутренний статус сервера на AWAITING_RECOVERY.

5) Какой либо из серверов был ONLINE и админ перевел его в OFFLINE:
   - Переводим сервер в ADMIN_OFFLINE и снимаем с него все роли. Отиправляем ему SET_STATUS.
   
   - Ждем завершения обработки сервером команды SET_STATUS. Если она закончилась неудачно, то 
     сообщаем администратору об этом и ??? (FIXME: не уверен, как тут поступать).

   - Если сервер был вынесен из кластера успешно, то берем все роли с упавшего сервера и 
     находим, куда их прикрутить (сверяясь с результатами проверок серверов и с их статусами)

   - Форсированно посылаем всем серверам, которые получили новые роли, команды SET_STATUS с 
     измененными параметрами.



Состояния серверов
~~~~~~~~~~~~~~~~~~

ONLINE - сервер доступен, мускуль работает и машина может принимать на себя роли (или уже приняла)

HARD_OFFLINE - не доступен весь сервер или мускуль. Никаких ролей на сервере нет.

ADMIN_OFFLINE - сервер отключен от кластера админом. Никаких ролей нет и на сервере 
                сделан SLAVE STOP.

AWAITING_RECOVERY - сервер был в HARD_OFFLINE, а сейчас появился и все проверки говорят, 
                    что он в порядке.

REPLICATION_DELAY - на сервере отстала репликация. После возвращения в нормальный 
                   статус оно должно запуститься заново.

REPLICATION_FAIL - на сервере остановилась репликация. После возвращения в нормальный 
                   статус оно должно запуститься заново.
